<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrendBeacon | TikTok Analytics Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #010101;
            color: #ffffff;
        }

        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .tiktok-gradient {
            background: linear-gradient(135deg, #FE2C55 0%, #25F4EE 100%);
        }

        .tiktok-btn {
            background-color: #FE2C55;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tiktok-btn:hover {
            box-shadow: 0 0 20px rgba(254, 44, 85, 0.5);
            transform: translateY(-2px);
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #010101;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .skeleton {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-up {
            animation: fadeUp 0.5s ease forwards;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        tiktokRed: '#FE2C55',
                        tiktokCyan: '#25F4EE',
                        darkBg: '#010101',
                        cardBg: 'rgba(255, 255, 255, 0.03)',
                    }
                }
            }
        }
    </script>
</head>

<body class="overflow-x-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Format large numbers
        function formatNumber(num) {
            if (!num && num !== 0) return '—';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        function timeAgo(timestamp) {
            if (!timestamp) return '—';
            const seconds = Math.floor(Date.now() / 1000 - timestamp);
            if (seconds < 60) return 'just now';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
            if (seconds < 604800) return Math.floor(seconds / 86400) + 'd ago';
            return Math.floor(seconds / 604800) + 'w ago';
        }

        const StatCard = ({ label, value, icon, color }) => (
            <div className="glass p-6 rounded-3xl transition-all duration-300 hover:bg-white/5 hover:-translate-y-1 fade-up">
                <div className="flex justify-between items-start mb-3">
                    <p className="text-gray-400 text-sm">{label}</p>
                    <i className={`${icon} text-lg`} style={{ color: color }}></i>
                </div>
                <h3 className="text-3xl font-bold">{value}</h3>
            </div>
        );

        const SkeletonCard = () => (
            <div className="glass p-6 rounded-3xl">
                <div className="skeleton h-4 w-24 mb-3"></div>
                <div className="skeleton h-8 w-32"></div>
            </div>
        );

        const NavItem = ({ icon, label, active, onClick }) => (
            <div
                onClick={onClick}
                className={`flex items-center gap-3 px-4 py-3 rounded-xl cursor-pointer transition-all duration-200 ${active ? 'bg-white/10 text-white border-l-4 border-tiktokRed' : 'text-gray-400 hover:bg-white/5 hover:text-white'}`}
            >
                <i className={`${icon} w-5`}></i>
                <span className="font-medium">{label}</span>
            </div>
        );

        const TrendBeacon = () => {
            const [view, setView] = useState('dashboard');
            const [userData, setUserData] = useState(null);
            const [videoData, setVideoData] = useState(null);
            const [followerGrowth, setFollowerGrowth] = useState(null);
            const [loading, setLoading] = useState(true);
            const [connected, setConnected] = useState(false);

            useEffect(() => {
                fetchData();
            }, []);

            async function fetchData() {
                setLoading(true);
                try {
                    const response = await fetch('/api/data');
                    const data = await response.json();
                    console.log('API Response:', data);

                    if (data.user && data.user.data && data.user.data.user) {
                        setUserData(data.user.data.user);
                        setConnected(true);
                    }
                    if (data.videos && data.videos.data && data.videos.data.videos) {
                        setVideoData(data.videos.data.videos);
                    }
                    if (data.follower_growth) {
                        setFollowerGrowth(data.follower_growth);
                    }
                } catch (err) {
                    console.log('Not connected yet or server not running:', err);
                }
                setLoading(false);
            }

            function handleLogin() {
                // Server handles all PKCE + OAuth logic now
                window.location.href = '/login';
            }

            // Calculate totals from videos
            const totalViews = videoData ? videoData.reduce((sum, v) => sum + (v.view_count || 0), 0) : 0;
            const totalLikes = videoData ? videoData.reduce((sum, v) => sum + (v.like_count || 0), 0) : 0;
            const totalComments = videoData ? videoData.reduce((sum, v) => sum + (v.comment_count || 0), 0) : 0;
            const totalShares = videoData ? videoData.reduce((sum, v) => sum + (v.share_count || 0), 0) : 0;
            const totalSaves = videoData ? videoData.reduce((sum, v) => sum + (v.favourite_count || 0), 0) : 0;

            return (
                <div className="flex min-h-screen">
                    {/* Sidebar */}
                    <aside className="w-72 glass border-r border-white/10 p-6 flex flex-col fixed h-screen">
                        <div className="flex items-center gap-3 mb-12">
                            <div className="w-10 h-10 tiktok-gradient rounded-xl flex items-center justify-center">
                                <i className="fab fa-tiktok text-white text-xl"></i>
                            </div>
                            <span className="text-xl font-bold tracking-tight">TrendBeacon</span>
                        </div>

                        {/* Connected User Profile */}
                        {connected && userData && (
                            <div className="glass rounded-2xl p-4 mb-6">
                                <div className="flex items-center gap-3">
                                    <img src={userData.avatar_url} className="w-10 h-10 rounded-full object-cover border-2 border-tiktokRed" alt="avatar" />
                                    <div>
                                        <p className="font-semibold text-sm">{userData.display_name}</p>
                                        <p className="text-xs text-green-400 flex items-center gap-1">
                                            <span className="w-2 h-2 bg-green-400 rounded-full inline-block"></span>
                                            Connected
                                        </p>
                                    </div>
                                </div>
                            </div>
                        )}

                        <nav className="flex-1 space-y-2">
                            <NavItem icon="fas fa-chart-line" label="Analytics" active={view === 'dashboard'} onClick={() => setView('dashboard')} />
                            <NavItem icon="fas fa-video" label="My Videos" active={view === 'videos'} onClick={() => setView('videos')} />
                            <NavItem icon="fas fa-hashtag" label="Trend Map" active={view === 'trends'} onClick={() => setView('trends')} />
                            <NavItem icon="fas fa-users" label="Audience" active={view === 'audience'} onClick={() => setView('audience')} />
                        </nav>

                        <div className="pt-6 border-t border-white/10">
                            <NavItem icon="fas fa-cog" label="Settings" />
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 ml-72 p-10">
                        <header className="flex justify-between items-start mb-12">
                            <div>
                                <h1 className="text-4xl font-extrabold mb-2 bg-gradient-to-r from-white to-gray-500 bg-clip-text text-transparent">
                                    {connected ? `${userData?.display_name || 'Creator'}'s Dashboard` : 'Creator Stats'}
                                </h1>
                                <p className="text-gray-400">
                                    {connected
                                        ? `${formatNumber(userData?.video_count || 0)} videos • ${formatNumber(userData?.follower_count || 0)} followers • ${formatNumber(userData?.likes_count || 0)} total likes`
                                        : 'Connect your TikTok account to see real analytics.'}
                                </p>
                            </div>
                            {!connected ? (
                                <button
                                    onClick={handleLogin}
                                    className="tiktok-btn px-6 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg shadow-tiktokRed/20"
                                >
                                    <i className="fab fa-tiktok"></i>
                                    Login with TikTok
                                </button>
                            ) : (
                                <button
                                    onClick={fetchData}
                                    className="bg-white/10 hover:bg-white/20 px-6 py-3 rounded-xl font-bold flex items-center gap-2 transition-all"
                                >
                                    <i className="fas fa-sync-alt"></i>
                                    Refresh Data
                                </button>
                            )}
                        </header>

                        {/* Top Stats */}
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-10">
                            {loading ? (
                                <>
                                    <SkeletonCard /><SkeletonCard /><SkeletonCard /><SkeletonCard />
                                </>
                            ) : connected ? (
                                <>
                                    <StatCard label="Followers" value={formatNumber(userData?.follower_count)} icon="fas fa-users" color="#25F4EE" />
                                    <StatCard label="Total Likes" value={formatNumber(userData?.likes_count)} icon="fas fa-heart" color="#FE2C55" />
                                    <StatCard label="Video Views" value={formatNumber(totalViews)} icon="fas fa-eye" color="#a78bfa" />
                                    <StatCard label="Total Saves" value={formatNumber(totalSaves)} icon="fas fa-bookmark" color="#facc15" />
                                    <StatCard label="Total Shares" value={formatNumber(totalShares)} icon="fas fa-share" color="#4ade80" />
                                    {followerGrowth && (
                                        <StatCard label="Follower Growth (Today)" value={`+${formatNumber(followerGrowth.growth_today)}`} icon="fas fa-chart-line" color="#22d3ee" />
                                    )}
                                </>
                            ) : (
                                <>
                                    <StatCard label="Followers" value="—" icon="fas fa-users" color="#25F4EE" />
                                    <StatCard label="Total Likes" value="—" icon="fas fa-heart" color="#FE2C55" />
                                    <StatCard label="Video Views" value="—" icon="fas fa-eye" color="#a78bfa" />
                                    <StatCard label="Total Saves" value="—" icon="fas fa-bookmark" color="#facc15" />
                                    <StatCard label="Total Shares" value="—" icon="fas fa-share" color="#4ade80" />
                                    <StatCard label="Follower Growth" value="—" icon="fas fa-chart-line" color="#22d3ee" />
                                </>
                            )}
                        </div>

                        {/* Video Stats Table */}
                        <div className="glass rounded-3xl overflow-hidden mb-10 fade-up" style={{ animationDelay: '0.2s' }}>
                            <div className="p-6 border-b border-white/10 flex justify-between items-center">
                                <h2 className="text-xl font-bold">
                                    {connected ? 'Your Video Performance' : 'Recent Video Performance'}
                                </h2>
                                {videoData && (
                                    <span className="text-sm text-gray-400">{videoData.length} videos loaded</span>
                                )}
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-left">
                                    <thead className="bg-white/5 text-gray-400 text-xs uppercase tracking-wider">
                                        <tr>
                                            <th className="px-6 py-4 font-semibold">Video</th>
                                            <th className="px-6 py-4 font-semibold">Views</th>
                                            <th className="px-6 py-4 font-semibold">Likes</th>
                                            <th className="px-6 py-4 font-semibold">Comments</th>
                                            <th className="px-6 py-4 font-semibold">Shares</th>
                                            <th className="px-6 py-4 font-semibold">Saves</th>
                                            <th className="px-6 py-4 font-semibold">Posted</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-white/5">
                                        {loading ? (
                                            [1, 2, 3].map(i => (
                                                <tr key={i}>
                                                    <td className="px-6 py-4"><div className="skeleton h-6 w-48"></div></td>
                                                    <td className="px-6 py-4"><div className="skeleton h-6 w-16"></div></td>
                                                    <td className="px-6 py-4"><div className="skeleton h-6 w-16"></div></td>
                                                    <td className="px-6 py-4"><div className="skeleton h-6 w-16"></div></td>
                                                    <td className="px-6 py-4"><div className="skeleton h-6 w-16"></div></td>
                                                    <td className="px-6 py-4"><div className="skeleton h-6 w-16"></div></td>
                                                </tr>
                                            ))
                                        ) : videoData && videoData.length > 0 ? (
                                            videoData.map((video, idx) => (
                                                <tr key={video.id || idx} className="hover:bg-white/5 transition-colors group">
                                                    <td className="px-6 py-4">
                                                        <div className="flex items-center gap-4">
                                                            {video.cover_image_url ? (
                                                                <img src={video.cover_image_url} className="w-12 h-16 object-cover rounded-lg" alt="" />
                                                            ) : (
                                                                <div className="w-12 h-16 bg-white/10 rounded-lg flex items-center justify-center">
                                                                    <i className="fas fa-video text-gray-500"></i>
                                                                </div>
                                                            )}
                                                            <div>
                                                                <span className="font-medium group-hover:text-tiktokCyan transition-colors block max-w-xs truncate">
                                                                    {video.title || video.video_description || `Video ${idx + 1}`}
                                                                </span>
                                                                {video.duration && (
                                                                    <span className="text-xs text-gray-500">{video.duration}s</span>
                                                                )}
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td className="px-6 py-4 font-medium">{formatNumber(video.view_count)}</td>
                                                    <td className="px-6 py-4 text-gray-400">{formatNumber(video.like_count)}</td>
                                                    <td className="px-6 py-4 text-gray-400">{formatNumber(video.comment_count)}</td>
                                                    <td className="px-6 py-4 text-gray-400">{formatNumber(video.share_count)}</td>
                                                    <td className="px-6 py-4 text-yellow-400 font-medium">{formatNumber(video.favourite_count)}</td>
                                                    <td className="px-6 py-4 text-gray-400">{timeAgo(video.create_time)}</td>
                                                </tr>
                                            ))
                                        ) : (
                                            <tr>
                                                <td colSpan="7" className="px-6 py-12 text-center text-gray-500">
                                                    {connected ? "No videos found on this account." : "Connect your TikTok account to see your videos."}
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {/* Profile Summary Card */}
                        {connected && userData && (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-10 fade-up" style={{ animationDelay: '0.3s' }}>
                                <div className="glass p-8 rounded-3xl border-l-4 border-tiktokCyan">
                                    <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
                                        <i className="fas fa-user-circle text-tiktokCyan"></i>
                                        Profile Summary
                                    </h3>
                                    <div className="space-y-3 text-gray-400">
                                        <p><span className="text-white font-medium">Display Name:</span> {userData.display_name}</p>
                                        <p><span className="text-white font-medium">Bio:</span> {userData.bio_description || 'No bio set'}</p>
                                        <p><span className="text-white font-medium">Following:</span> {formatNumber(userData.following_count)}</p>
                                        <p><span className="text-white font-medium">Verified:</span> {userData.is_verified ? '✅ Yes' : '❌ No'}</p>
                                    </div>
                                    {userData.profile_deep_link && (
                                        <a href={userData.profile_deep_link} target="_blank" className="inline-block mt-4 text-sm font-bold border border-tiktokCyan/50 text-tiktokCyan px-4 py-2 rounded-lg hover:bg-tiktokCyan/10 transition-all">
                                            View TikTok Profile
                                        </a>
                                    )}
                                </div>
                                <div className="glass p-8 rounded-3xl border-l-4 border-tiktokRed">
                                    <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
                                        <i className="fas fa-chart-pie text-tiktokRed"></i>
                                        Engagement Breakdown
                                    </h3>
                                    <div className="space-y-4">
                                        <div>
                                            <div className="flex justify-between text-sm mb-1">
                                                <span className="text-gray-400">Likes per Video</span>
                                                <span className="text-white font-medium">{videoData && videoData.length > 0 ? formatNumber(Math.round(totalLikes / videoData.length)) : '—'}</span>
                                            </div>
                                            <div className="w-full h-2 bg-white/10 rounded-full overflow-hidden">
                                                <div className="h-full bg-tiktokRed rounded-full" style={{ width: '70%' }}></div>
                                            </div>
                                        </div>
                                        <div>
                                            <div className="flex justify-between text-sm mb-1">
                                                <span className="text-gray-400">Saves per Video</span>
                                                <span className="text-yellow-400 font-medium">{videoData && videoData.length > 0 ? formatNumber(Math.round(totalSaves / videoData.length)) : '—'}</span>
                                            </div>
                                            <div className="w-full h-2 bg-white/10 rounded-full overflow-hidden">
                                                <div className="h-full bg-yellow-400 rounded-full" style={{ width: '55%' }}></div>
                                            </div>
                                        </div>
                                        <div>
                                            <div className="flex justify-between text-sm mb-1">
                                                <span className="text-gray-400">Comments per Video</span>
                                                <span className="text-white font-medium">{videoData && videoData.length > 0 ? formatNumber(Math.round(totalComments / videoData.length)) : '—'}</span>
                                            </div>
                                            <div className="w-full h-2 bg-white/10 rounded-full overflow-hidden">
                                                <div className="h-full bg-tiktokCyan rounded-full" style={{ width: '45%' }}></div>
                                            </div>
                                        </div>
                                        <div>
                                            <div className="flex justify-between text-sm mb-1">
                                                <span className="text-gray-400">Shares per Video</span>
                                                <span className="text-white font-medium">{videoData && videoData.length > 0 ? formatNumber(Math.round(totalShares / videoData.length)) : '—'}</span>
                                            </div>
                                            <div className="w-full h-2 bg-white/10 rounded-full overflow-hidden">
                                                <div className="h-full bg-purple-500 rounded-full" style={{ width: '25%' }}></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Follower Growth Card */}
                                {followerGrowth && followerGrowth.history && followerGrowth.history.length > 0 && (
                                    <div className="glass p-8 rounded-3xl border-l-4 border-green-400 md:col-span-2">
                                        <h3 className="text-xl font-bold mb-4 flex items-center gap-2">
                                            <i className="fas fa-arrow-trend-up text-green-400"></i>
                                            Follower Growth Tracker
                                        </h3>
                                        <div className="grid grid-cols-3 gap-6 mb-6">
                                            <div className="glass p-4 rounded-xl text-center">
                                                <p className="text-gray-400 text-xs mb-1">Today</p>
                                                <p className={`text-2xl font-bold ${followerGrowth.growth_today >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                                    {followerGrowth.growth_today >= 0 ? '+' : ''}{formatNumber(followerGrowth.growth_today)}
                                                </p>
                                            </div>
                                            <div className="glass p-4 rounded-xl text-center">
                                                <p className="text-gray-400 text-xs mb-1">This Week</p>
                                                <p className={`text-2xl font-bold ${followerGrowth.growth_week >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                                    {followerGrowth.growth_week >= 0 ? '+' : ''}{formatNumber(followerGrowth.growth_week)}
                                                </p>
                                            </div>
                                            <div className="glass p-4 rounded-xl text-center">
                                                <p className="text-gray-400 text-xs mb-1">This Month</p>
                                                <p className={`text-2xl font-bold ${followerGrowth.growth_month >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                                    {followerGrowth.growth_month >= 0 ? '+' : ''}{formatNumber(followerGrowth.growth_month)}
                                                </p>
                                            </div>
                                        </div>
                                        <div className="text-xs text-gray-500">
                                            <i className="fas fa-info-circle"></i> Growth data is recorded each time you load the dashboard. Check back daily for accurate tracking.
                                            <span className="ml-2">({followerGrowth.history.length} data point{followerGrowth.history.length > 1 ? 's' : ''} recorded)</span>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<TrendBeacon />);
    </script>
</body>

</html>